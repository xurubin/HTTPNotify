<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>HTTPNotify</title>
		<meta name="description" content="Watch HTTP conent and notify users of change by SMS">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/themes/redmond/jquery-ui.css">
		<style>
			#listview {
				margin: auto;
				width: 600px;
			}
			.entry {
				border: 1px dotted black;
				padding: 3px;
				margin: 5px;
			}
			input{
 			   width: 100%
			}
			span.container {
			    display: block;
			    overflow: hidden;
			    padding-right:10px;
			}
			span.content {
				display: inline-block;
				min-width:200px;
			}
			div.loading {
				display:inline;
				float: right;
				width:32px; 
				height:32px;
			}	
			.ajax-loading {
			    background: url('static/ajax-loader.gif') scroll no-repeat 50% 50% transparent;
			    width: 100%;
			    height: 100%;
			}		
			#left button{
			    float: left;
			}
		</style>
		<script>
		function NewEntryDiv(content) {
			var template = $("#TemplateEntry");
			var entry = template.clone(true).attr("id", "").hide();
			template.before(entry);
			UpdateEntryContent(entry, content);			
			entry.find('[name="Add"]').hide();
			entry.find('[name="Save"]').show();
			entry.find('[name="Delete"]').show();
			entry.find('[name="Recheck"]').show();
			entry.find('[name="Reset"]').show();

			entry.slideDown();
		};
		function UpdateEntryContent(entry, content) {
			if ('id' in content)
				entry.attr('id', content.id);
			if ('url' in content)
				entry.find('[name="URL"]').val(content.url);
			if ('regex' in content)
				entry.find('[name="Regex"]').val(content.regex);
			if ('telnum' in content)
				entry.find('[name="Phone"]').val(content.telnum);
			if ('interval' in content)
				entry.find('[name="Interval"]').val(content.interval);
			if ('mtime' in content)
				entry.find('[name="LastCheck"]').html(content.mtime);
			if ('status' in content)
				entry.find('[name="Status"]').html(content.status);
		};
		function GetEntryContent(entry) {
			return {
				id: entry.attr('id'),
				url: entry.find('[name="URL"]').val(),
				regex: entry.find('[name="Regex"]').val(), 
				interval: entry.find('[name="Interval"]').val(),
				telnum: entry.find('[name="Phone"]').val(),
			};
		};
		function AddEntry(entry) {
			$.ajax({ 
				url: "/add",
				type: "POST",
				data: GetEntryContent(entry),
				dataType: "json",
				beforeSend : function() {
					entry.find('.loading').addClass("ajax-loading");
				}}).always(function() {
					entry.find('.loading').removeClass("ajax-loading");
				}).done(function(data) {
					if (data.result)
						NewEntryDiv(data.entry);
				}).fail(function(jqXHR, textStatus) {
					alert( "AddEntry Request failed: " + textStatus );
				});
		};
		function SaveEntry(entry) {
			$.ajax({ 
				url: "/update/" + entry.attr('id'),
				type: "POST",
				dataType: "json",
				beforeSend : function() {
					entry.find('.loading').addClass("ajax-loading");
				}}).always(function() {
					entry.find('.loading').removeClass("ajax-loading");
				}).done(function(data) {
					if (data.result)
						UpdateEntryContent(entry, data.entry);
				}).fail(function(jqXHR, textStatus) {
					alert( "SaveEntry Request failed: " + textStatus );
				});
		};
		function DeleteEntry(entry) {
			$.ajax({ 
				url: "/delete/" + entry.attr('id'),
				type: "POST",
				dataType: "json",
				}).done(function(data) {
					if (data.result) {
						entry.slideUp(400, function() {entry.remove()});
					}
				}).fail(function(jqXHR, textStatus) {
					alert( "DeleteEntry Request failed: " + textStatus );
				});
		};
		function RecheckEntry(entry) {
			$.ajax({ 
				url: "/refresh/" + entry.attr('id'),
				type: "GET",
				dataType: "json",
				beforeSend : function() {
					entry.find('.loading').addClass("ajax-loading");
				}}).always(function() {
					entry.find('.loading').removeClass("ajax-loading");
				}).done(function(data) {
					if (data.result)
						UpdateEntryContent(entry, data.entry);
				}).fail(function(jqXHR, textStatus) {
					alert( "RecheckEntry Request failed: " + textStatus );
				});
		};
		function ResetEntry(entry) {
			$.ajax({ 
				url: "/reset/" + entry.attr('id'),
				type: "POST",
				dataType: "json",
				beforeSend : function() {
					entry.find('.loading').addClass("ajax-loading");
				}}).always(function() {
					entry.find('.loading').removeClass("ajax-loading");
				}).done(function(data) {
					if (data.result) 
						UpdateEntryContent(entry, data.entry);
				}).fail(function(jqXHR, textStatus) {
					alert( "ResetEntry Request failed: " + textStatus );
				});
		};
		
		function initEntryDiv(entry) {
			$(entry).find("[name='Add']").click(function() {
				AddEntry($(this).parents(".entry"));
			});
			$(entry).find("[name='Save']").click(function() {
				SaveEntry($(this).parents(".entry"));
			});
			$(entry).find("[name='Delete']").click(function() {
				DeleteEntry($(this).parents(".entry"));
			});
			$(entry).find("[name='Reset']").click(function() {
				ResetEntry($(this).parents(".entry"));
			});
			$(entry).find("[name='Recheck']").click(function() {
				RecheckEntry($(this).parents(".entry"));
			});
			
			$(entry).find('[name="Add"]').show();
			$(entry).find('[name="Save"]').hide();
			$(entry).find('[name="Reset"]').hide();
			$(entry).find('[name="Delete"]').hide();
			$(entry).find('[name="Recheck"]').hide();
			
		}
		$(document).ready( function() {
			$('<img/>')[0].src = "static/ajax-loader.gif"; // Preload image
			initEntryDiv(".entry");
    		$("#loading").ajaxStart(function(){
			  $(this).show();
			}).ajaxStop(function(){
			  $(this).hide();
			});
		});
		</script>
		<script>
		$(document).ready( function() {
 			{% for entry in entries %}
 			NewEntryDiv({{ entry|safe  }});
    		{% endfor %}
		});
		</script>
	</head>
	<body>
		<div id='listview'>
			<div id="TemplateEntry" name='WatchEntry' class="entry">
				<span class="container">
					<label>URL: </label> <input name='URL' /></span> 
				</span>
				<span class="container">
					<label>Regex: </label> <input name='Regex' />
				</span>
				<span class="container">
					<label>Phone Number: </label> <input name='Phone' />
				</span>
				<span class="container">
					<label>Interval: </label><input name="Interval" />
				</span>
				
				<span class="content">
					<label>Status: </label> <span name="Status"></span>
				</span>
				<button name="Reset">Reset</button>
				<br />
				
				<span class="content">
					<label>Last Check: </label><span name="LastCheck"></span>
				</span>
				<button name="Recheck">Recheck</button>
				<br />
				<button name="Add">Add</button>
				<button name="Save">Save</button>
				<button name="Delete">Delete</button>
				<div class='loading'></div>
			</div>
		</div>
	</body>
</html>